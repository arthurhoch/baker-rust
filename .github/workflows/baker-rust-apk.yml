name: baker-rust-apk

on:
  push:
    paths:
      - "baker-rust/**"
      - ".github/workflows/baker-rust-apk.yml"
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-alpine:
    runs-on: ubuntu-latest
    container: alpine:3.20
    steps:
      - name: Install build deps
        run: |
          apk add --no-cache git alpine-sdk cargo doas
      - name: Create abuild user
        run: |
          adduser -D builder
          addgroup builder abuild
      - name: Checkout
        uses: actions/checkout@v4
      - name: Trust workspace ownership for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Fix ownership for abuild
        run: chown -R builder:abuild "$GITHUB_WORKSPACE"
      - name: Install signing key
        env:
          ABUILD_PRIVKEY_B64: ${{ secrets.ABUILD_PRIVKEY_B64 }}
        run: |
          mkdir -p /home/builder/.abuild
          if [ -n "$ABUILD_PRIVKEY_B64" ]; then
            echo "$ABUILD_PRIVKEY_B64" | base64 -d > /home/builder/.abuild/packager.rsa
            chmod 600 /home/builder/.abuild/packager.rsa
            install -m644 "$GITHUB_WORKSPACE/root-69263073.rsa.pub" /home/builder/.abuild/packager.rsa.pub
          else
            su builder -c 'abuild-keygen -a -n -q'
            PRIVKEY=$(su builder -c "ls /home/builder/.abuild/*.rsa | head -n1")
            PUBKEY="${PRIVKEY}.pub"
            ln -sf "$PRIVKEY" /home/builder/.abuild/packager.rsa
            ln -sf "$PUBKEY" /home/builder/.abuild/packager.rsa.pub
          fi
          install -m644 /home/builder/.abuild/packager.rsa.pub /etc/apk/keys/
          chown -R builder:abuild /home/builder/.abuild
      - name: Create source tarball
        working-directory: ${{ github.workspace }}
        run: |
          PROJECT_DIR="$GITHUB_WORKSPACE"
          if [ ! -f "$PROJECT_DIR/Cargo.toml" ] && [ -f "$PROJECT_DIR/baker-rust/Cargo.toml" ]; then
            PROJECT_DIR="$PROJECT_DIR/baker-rust"
          fi
          PKGVER=$(grep '^version' "$PROJECT_DIR/Cargo.toml" | head -n1 | cut -d'=' -f2 | tr -d ' "')
          mkdir -p /var/cache/distfiles
          (cd "$PROJECT_DIR" && git archive --format=tar.gz --output "/var/cache/distfiles/baker-rust-$PKGVER.tar.gz" --prefix="baker-rust-$PKGVER/" HEAD)
          cp "/var/cache/distfiles/baker-rust-$PKGVER.tar.gz" "$GITHUB_WORKSPACE/"
      - name: Build APK
        working-directory: ${{ github.workspace }}
        run: |
          PROJECT_DIR="$GITHUB_WORKSPACE"
          if [ ! -f "$PROJECT_DIR/Cargo.toml" ] && [ -f "$PROJECT_DIR/baker-rust/Cargo.toml" ]; then
            PROJECT_DIR="$PROJECT_DIR/baker-rust"
          fi
          su builder -c "cd $PROJECT_DIR; PKGVER=$(grep '^version' Cargo.toml | head -n1 | cut -d'=' -f2 | tr -d ' \"'); SRCDEST=/var/cache/distfiles ABUILD_SRCDEST=/var/cache/distfiles PACKAGER_PRIVKEY=/home/builder/.abuild/packager.rsa abuild checksum; SRCDEST=/var/cache/distfiles ABUILD_SRCDEST=/var/cache/distfiles PACKAGER_PRIVKEY=/home/builder/.abuild/packager.rsa abuild -r"
      - name: Build standalone binary
        working-directory: ${{ github.workspace }}
        run: |
          PROJECT_DIR="$GITHUB_WORKSPACE"
          if [ ! -f "$PROJECT_DIR/Cargo.toml" ] && [ -f "$PROJECT_DIR/baker-rust/Cargo.toml" ]; then
            PROJECT_DIR="$PROJECT_DIR/baker-rust"
          fi
          cargo build --release --manifest-path "$PROJECT_DIR/Cargo.toml"
          ARCH=$(apk --print-arch)
          mkdir -p publish/binaries/"$ARCH"
          cp "$PROJECT_DIR/target/release/baker-rust" "publish/binaries/$ARCH/baker-rust"
      - name: Prepare Pages content
        run: |
          ARCH=$(apk --print-arch)
          mkdir -p publish/alpine/baker-rust/"$ARCH"
          cp -a /home/builder/packages/baker-rust/"$ARCH"/. publish/alpine/baker-rust/"$ARCH"/
          # publish the actual signing key used by abuild
          cp /home/builder/.abuild/packager.rsa.pub publish/alpine/baker-rust/"$ARCH"/packager.rsa.pub
          # keep the legacy root key alongside if present
          if [ -f "$GITHUB_WORKSPACE/root-69263073.rsa.pub" ]; then
            cp "$GITHUB_WORKSPACE/root-69263073.rsa.pub" publish/alpine/baker-rust/"$ARCH"/root-69263073.rsa.pub
          fi
          cp "$GITHUB_WORKSPACE/arch-index.html" publish/alpine/baker-rust/"$ARCH"/index.html
          # site root for project pages
          cp "$GITHUB_WORKSPACE/index.html" publish/index.html
          # root redirect for org-level pages if served
          cp "$GITHUB_WORKSPACE/root-index.html" publish/root-index.html
      - name: Upload pages content (alpine)
        uses: actions/upload-artifact@v4
        with:
          name: pages-alpine
          path: publish
      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: baker-rust-apk
          path: |
            /home/builder/packages/**/baker-rust-*.apk
            /home/builder/packages/**/APKINDEX.tar.gz
            publish/binaries/**/baker-rust

  build-wolfi:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/wolfi-dev/sdk:latest
      options: --privileged
    defaults:
      run:
        shell: sh
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install build tools
        run: apk add --no-cache apk-tools openssl
      - name: Trust workspace ownership for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"
      - name: Set project metadata
        run: |
          set -euo pipefail
          PROJECT_DIR="$GITHUB_WORKSPACE"
          if [ ! -f "$PROJECT_DIR/Cargo.toml" ] && [ -f "$PROJECT_DIR/baker-rust/Cargo.toml" ]; then
            PROJECT_DIR="$PROJECT_DIR/baker-rust"
          fi
          PKGVER=$(grep '^version' "$PROJECT_DIR/Cargo.toml" | head -n1 | cut -d'=' -f2 | tr -d ' "')
          SPECVER=$(awk '/^  version:/{print $2; exit}' "$PROJECT_DIR/wolfi/melange.yaml")
          if [ -n "$SPECVER" ] && [ "$SPECVER" != "$PKGVER" ]; then
            echo "melange.yaml version ($SPECVER) does not match Cargo.toml version ($PKGVER)" >&2
            exit 1
          fi
          echo "PROJECT_DIR=$PROJECT_DIR" >> "$GITHUB_ENV"
          echo "PKGVER=$PKGVER" >> "$GITHUB_ENV"
      - name: Install signing key for melange
        env:
          MELANGE_PRIVKEY_B64: ${{ secrets.MELANGE_PRIVKEY_B64 }}
        run: |
          set -euo pipefail
          KEY_PATH="$PROJECT_DIR/wolfi/melange.rsa"
          PUB_PATH="$KEY_PATH.pub"
          mkdir -p "$(dirname "$KEY_PATH")"
          if [ -n "$MELANGE_PRIVKEY_B64" ]; then
            echo "$MELANGE_PRIVKEY_B64" | base64 -d > "$KEY_PATH"
            # Normalize to PKCS1 RSA if provided as PKCS8
            if openssl pkey -in "$KEY_PATH" -inform PEM -out "$KEY_PATH.pkcs1" -outform PEM -traditional >/dev/null 2>&1; then
              mv "$KEY_PATH.pkcs1" "$KEY_PATH"
            fi
            if ! openssl rsa -in "$KEY_PATH" -pubout -out "$PUB_PATH"; then
              echo "Provided MELANGE_PRIVKEY_B64 is not a usable RSA key; falling back to generated key" >&2
              melange keygen --out "$KEY_PATH"
            fi
          else
            melange keygen --out "$KEY_PATH"
            if [ ! -f "$PUB_PATH" ] && [ -f "$KEY_PATH.pub" ]; then
              cp "$KEY_PATH.pub" "$PUB_PATH"
            fi
          fi
          if [ ! -f "$PUB_PATH" ] && [ -f "$KEY_PATH.pub" ]; then
            cp "$KEY_PATH.pub" "$PUB_PATH"
          fi
          # Trust the public key locally for apk tooling
          install -m644 "$PUB_PATH" /etc/apk/keys/
          chmod 600 "$KEY_PATH"
          echo "MELANGE_KEY=$KEY_PATH" >> "$GITHUB_ENV"
      - name: Build Wolfi packages
        run: |
          set -euo pipefail
          OUTDIR="$GITHUB_WORKSPACE/wolfi-out"
          mkdir -p "$OUTDIR"
          HOST_ARCH=$(apk --print-arch)
          for ARCH in $HOST_ARCH; do
            melange build "$PROJECT_DIR/wolfi/melange.yaml" \
              --arch "$ARCH" \
              --signing-key "$MELANGE_KEY" \
              --out-dir "$OUTDIR" \
              --source-dir "$PROJECT_DIR" \
              --repository-append https://packages.wolfi.dev/os \
              --keyring-append https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
            (
              cd "$OUTDIR/$ARCH"
              melange index --arch "$ARCH" --signing-key "$MELANGE_KEY" ./*.apk
            )
          done
          echo "WOLFI_OUT=$OUTDIR" >> "$GITHUB_ENV"
      - name: Prepare Pages content (wolfi)
        run: |
          set -euo pipefail
          PUBLISH="$GITHUB_WORKSPACE/publish-wolfi"
          mkdir -p "$PUBLISH"
          HOST_ARCH=$(apk --print-arch)
          for ARCH in $HOST_ARCH; do
            mkdir -p "$PUBLISH/wolfi/baker-rust/$ARCH"
            cp "$WOLFI_OUT/$ARCH"/*.apk "$PUBLISH/wolfi/baker-rust/$ARCH"/
            if [ -f "$WOLFI_OUT/$ARCH/APKINDEX.tar.gz" ]; then
              cp "$WOLFI_OUT/$ARCH/APKINDEX.tar.gz" "$PUBLISH/wolfi/baker-rust/$ARCH"/
            fi
            cp "$MELANGE_KEY.pub" "$PUBLISH/wolfi/baker-rust/$ARCH/melange.rsa.pub"
            cp "$MELANGE_KEY.pub" "$PUBLISH/wolfi/baker-rust/$ARCH/packager.rsa.pub"
            cp "$GITHUB_WORKSPACE/arch-index.html" "$PUBLISH/wolfi/baker-rust/$ARCH/index.html"
          done
      - name: Upload pages content (wolfi)
        uses: actions/upload-artifact@v4
        with:
          name: pages-wolfi
          path: publish-wolfi
      - name: Upload Wolfi packages
        uses: actions/upload-artifact@v4
        with:
          name: baker-rust-wolfi
          path: |
            wolfi-out/**/*.apk
            wolfi-out/**/APKINDEX.tar.gz

  prepare-pages:
    needs:
      - build-alpine
      - build-wolfi
    runs-on: ubuntu-latest
    steps:
      - name: Download Alpine pages
        uses: actions/download-artifact@v4
        with:
          name: pages-alpine
          path: pages/alpine
      - name: Download Wolfi pages
        uses: actions/download-artifact@v4
        with:
          name: pages-wolfi
          path: pages/wolfi
      - name: Merge pages
        run: |
          mkdir -p publish
          if [ -d "pages/alpine" ]; then
            cp -a pages/alpine/. publish/
          fi
          if [ -d "pages/wolfi" ]; then
            cp -a pages/wolfi/. publish/
          fi
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: publish

  deploy-pages:
    needs: prepare-pages
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          # publish both the site and root redirect (uploaded artifacts)
          token: ${{ secrets.GITHUB_TOKEN }}

  test-install-alpine:
    needs: deploy-pages
    runs-on: ubuntu-latest
    container: alpine:3.20
    steps:
      - name: Install from published repo
        run: |
          apk add --no-cache ca-certificates
          echo "https://arthurhoch.github.io/baker-rust/alpine/baker-rust" >> /etc/apk/repositories
          ARCH=$(apk --print-arch)
          wget -O /etc/apk/keys/packager.rsa.pub https://arthurhoch.github.io/baker-rust/alpine/baker-rust/$ARCH/packager.rsa.pub
          apk update
          apk add baker-rust
          baker-rust --help

  test-install-wolfi:
    needs: deploy-pages
    runs-on: ubuntu-latest
    container: cgr.dev/chainguard/wolfi-base
    steps:
      - name: Install from published repo (wolfi)
        run: |
          apk add --no-cache ca-certificates wget
          echo "https://arthurhoch.github.io/baker-rust/wolfi/baker-rust" >> /etc/apk/repositories
          ARCH=$(apk --print-arch)
          wget -O /etc/apk/keys/melange.rsa.pub https://arthurhoch.github.io/baker-rust/wolfi/baker-rust/$ARCH/melange.rsa.pub
          apk update
          apk add baker-rust
          baker-rust --help

  release:
    needs:
      - build-alpine
      - build-wolfi
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: baker-rust-apk
          path: release-artifacts
      - name: Download Wolfi packages
        uses: actions/download-artifact@v4
        with:
          name: baker-rust-wolfi
          path: release-artifacts-wolfi
      - name: Prepare release asset names
        run: |
          set -euo pipefail
          mkdir -p release-upload
          # Alpine artifacts
          if [ -d release-artifacts ]; then
            find release-artifacts -type f -name '*.apk' | while read -r f; do
              ARCH=$(basename "$(dirname "$f")")
              cp "$f" "release-upload/alpine-${ARCH}-$(basename "$f")"
            done
            find release-artifacts -type f -name 'APKINDEX.tar.gz' | while read -r f; do
              ARCH=$(basename "$(dirname "$f")")
              cp "$f" "release-upload/alpine-${ARCH}-APKINDEX.tar.gz"
            done
          fi
          # Wolfi artifacts
          if [ -d release-artifacts-wolfi ]; then
            find release-artifacts-wolfi -type f -name '*.apk' | while read -r f; do
              ARCH=$(basename "$(dirname "$f")")
              cp "$f" "release-upload/wolfi-${ARCH}-$(basename "$f")"
            done
            find release-artifacts-wolfi -type f -name 'APKINDEX.tar.gz' | while read -r f; do
              ARCH=$(basename "$(dirname "$f")")
              cp "$f" "release-upload/wolfi-${ARCH}-APKINDEX.tar.gz"
            done
          fi
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-upload/*
          token: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
